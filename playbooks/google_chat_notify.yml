---
- name: Notifica√ß√µes Google Chat - ServiceNow
  hosts: localhost
  gather_facts: false
  vars_files:
    - "../group_vars/all.yml"
  
  tasks:
    - name: Preparar mensagem para novos incidentes
      set_fact:
        new_incidents_message: |
          üö® **Novos Incidentes ({{ new_incidents | length }})**
          {% for incident in new_incidents %}
          ‚Ä¢ **{{ incident.number }}** - {{ incident.short_description }}
            Prioridade: {{ incident.priority }} | Categoria: {{ incident.category }}
            Link: https://{{ servicenow.instance }}/nav_to.do?uri=incident.do?sys_id={{ incident.sys_id }}
          {% endfor %}
      when: new_incidents is defined and new_incidents | length > 0
    
    - name: Preparar mensagem para SLA warnings
      set_fact:
        sla_warning_message: |
          ‚ö†Ô∏è **SLA Pr√≥ximo de Violar ({{ sla_warning_incidents | length }})**
          {% for incident in sla_warning_incidents %}
          ‚Ä¢ **{{ incident.number }}** - {{ incident.short_description }}
            SLA Due: {{ incident.sla_due }} | Prioridade: {{ incident.priority }}
            Link: https://{{ servicenow.instance }}/nav_to.do?uri=incident.do?sys_id={{ incident.sys_id }}
          {% endfor %}
      when: sla_warning_incidents is defined and sla_warning_incidents | length > 0
    
    - name: Preparar mensagem para SLA violado
      set_fact:
        sla_violated_message: |
          üö® **SLA Violado ({{ sla_violated_incidents | length }})**
          {% for incident in sla_violated_incidents %}
          ‚Ä¢ **{{ incident.number }}** - {{ incident.short_description }}
            SLA Due: {{ incident.sla_due }} | Prioridade: {{ incident.priority }}
            Link: https://{{ servicenow.instance }}/nav_to.do?uri=incident.do?sys_id={{ incident.sys_id }}
          {% endfor %}
      when: sla_violated_incidents is defined and sla_violated_incidents | length > 0
    
    - name: Preparar mensagem para tickets stale
      set_fact:
        stale_tickets_message: |
          ‚è∞ **Tickets Sem Atualiza√ß√£o ({{ stale_incidents | length }})**
          {% for incident in stale_incidents %}
          ‚Ä¢ **{{ incident.number }}** - {{ incident.short_description }}
            √öltima Atualiza√ß√£o: {{ incident.sys_updated_on }} | Prioridade: {{ incident.priority }}
            Link: https://{{ servicenow.instance }}/nav_to.do?uri=incident.do?sys_id={{ incident.sys_id }}
          {% endfor %}
      when: stale_incidents is defined and stale_incidents | length > 0
    
    - name: Preparar mensagem para novos changes
      set_fact:
        new_changes_message: |
          üìã **Novos Changes ({{ new_changes | length }})**
          {% for change in new_changes %}
          ‚Ä¢ **{{ change.number }}** - {{ change.short_description }}
            Estado: {{ change.state }} | Prioridade: {{ change.priority }}
            Link: https://{{ servicenow.instance }}/nav_to.do?uri=change_request.do?sys_id={{ change.sys_id }}
          {% endfor %}
      when: new_changes is defined and new_changes | length > 0
    
    - name: Construir mensagem completa
      set_fact:
        full_message: |
          üìä **Relat√≥rio ServiceNow - {{ ansible_date_time.iso8601 }}**
          
          {% if new_incidents_message is defined %}
          {{ new_incidents_message }}
          
          {% endif %}
          {% if sla_warning_message is defined %}
          {{ sla_warning_message }}
          
          {% endif %}
          {% if sla_violated_message is defined %}
          {{ sla_violated_message }}
          
          {% endif %}
          {% if stale_tickets_message is defined %}
          {{ stale_tickets_message }}
          
          {% endif %}
          {% if new_changes_message is defined %}
          {{ new_changes_message }}
          
          {% endif %}
          ---
          üîó **Links √öteis:**
          ‚Ä¢ [ServiceNow Dashboard](https://{{ servicenow.instance }}/nav_to.do?uri=dashboard.do)
          ‚Ä¢ [Relat√≥rio de SLA](https://{{ servicenow.instance }}/nav_to.do?uri=report.do?sys_id=...)
    
    - name: Preparar card do Google Chat
      set_fact:
        google_chat_card:
          cards:
            - header:
                title: "ServiceNow Monitor - {{ ansible_date_time.iso8601 }}"
                subtitle: "{{ google_chat.space_name }}"
                imageUrl: "https://www.servicenow.com/content/dam/servicenow-assets/public/images/favicon.ico"
              sections:
                - widgets:
                    - textParagraph:
                        text: "{{ full_message }}"
                - widgets:
                    - buttons:
                        - textButton:
                            text: "Ver ServiceNow"
                            onClick:
                              openLink:
                                url: "https://{{ servicenow.instance }}"
                        - textButton:
                            text: "Dashboard"
                            onClick:
                              openLink:
                                url: "https://{{ servicenow.instance }}/nav_to.do?uri=dashboard.do"
    
    - name: Enviar notifica√ß√£o para Google Chat
      uri:
        url: "{{ google_chat.webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body: "{{ google_chat_card }}"
        timeout: "{{ google_chat.timeout }}"
        status_code: [200, 204]
      register: chat_response
      retries: "{{ retry.max_attempts }}"
      delay: "{{ retry.delay }}"
      until: chat_response.status in [200, 204]
    
    - name: Verificar resposta do Google Chat
      debug:
        msg: "Notifica√ß√£o enviada com sucesso para Google Chat"
      when: chat_response.status in [200, 204]
    
    - name: Falhar se n√£o conseguir enviar notifica√ß√£o
      fail:
        msg: "Falha ao enviar notifica√ß√£o para Google Chat. Status: {{ chat_response.status }}"
      when: chat_response.status not in [200, 204]
