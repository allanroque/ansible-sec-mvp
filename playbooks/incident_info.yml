---
- name: Incidentes abertos + classificação SLA + notificação
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - servicenow.itsm

  vars:
    # Regras SLA em minutos
    near_breach_minutes: 60
    window_minutes_new: 15
    nomeacao_minutos:
      1: 15      # P1 - CRITICAL
      2: 30      # P2 - HIGH
      3: 90      # P3 - MEDIUM
      4: 180     # P4 - LOW
      5: 9999
    resolucao_minutos:
      1: 240     # P1 - 4h
      2: 900     # P2 - 15h
      3: 3600    # P3 - 2,5 dias
      4: 7200    # P4 - 5 dias
      default: 999999

  pre_tasks:
    - name: Resolver credenciais (Credential Type → env)
      set_fact:
        sn_instance: "{{ lookup('env', 'SN_HOST') }}"
        sn_username: "{{ lookup('env', 'SN_USERNAME') }}"
        sn_password: "{{ lookup('env', 'SN_PASSWORD') }}"

    - name: Validar credenciais
      assert:
        that:
          - sn_instance is match("https?://.+")
          - sn_username | length > 0
          - sn_password | length > 0
        fail_msg: >
          As credenciais do ServiceNow não foram resolvidas.
          Verifique se o Credential Type está configurado corretamente.

    - name: Mostrar credenciais resolvidas (sem senha)
      debug:
        msg:
          - "ServiceNow instance: {{ sn_instance }}"
          - "ServiceNow username: {{ sn_username }}"

  tasks:
    # ---------- Coletar incidentes no ServiceNow ----------
    - name: Buscar incidentes abertos (active=true)
      servicenow.itsm.incident_info:
        instance:
          host: "{{ lookup('env', 'SN_HOST') }}"
          username: "{{ lookup('env', 'SN_USERNAME') }}"
          password: "{{ lookup('env', 'SN_PASSWORD') }}"
        sysparm_query: "active=true"
#        sysparm_query: "active=true^assignment_group.name=Instruqt"
        sysparm_display_value: "true"
      register: abertas

    - name: Contagem total
      debug:
        msg: "Total de incidentes abertos encontrados: {{ abertas.records | length }}"

    - name: Normalizar lista de incidentes
      set_fact:
        inc_all: "{{ abertas.records | default([]) }}"

    - name: Epoch atual (UTC)
      set_fact:
        now_epoch: "{{ lookup('pipe','date -u +%s') | int }}"

    - name: Inicializar buckets
      set_fact:
        fora_nomeacao: []
        fora_resolucao: []
        near_breach: []
        novos: []

    # --------- NOVOS (≤ janela) ---------
    - name: Adicionar em NOVOS quando opened_at <= {{ window_minutes_new }} min atrás
      set_fact:
        novos: "{{ novos + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d "' ~ (item.opened_at | default('1970-01-01 00:00:00')) ~ '" +%s') | int)
          }}
        delta_sec: "{{ (now_epoch | int) - (opened_epoch | int) }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - (delta_sec | int) <= (window_minutes_new | int) * 60

    # --------- Fora do prazo de nomeação ---------
    - name: Classificar incidentes fora do prazo de nomeação
      set_fact:
        fora_nomeacao: "{{ fora_nomeacao + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d "' ~ (item.opened_at | default('1970-01-01 00:00:00')) ~ '" +%s') | int)
          }}
        delta_open_sec: "{{ (now_epoch | int) - (opened_epoch | int) }}"
        tem_owner: >-
          {{ (item.assigned_to is defined) and ((item.assigned_to | string | trim) != '') }}
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - not tem_owner
        - (item.priority | int) in nomeacao_minutos.keys()
        - (delta_open_sec | int) >= (nomeacao_minutos[item.priority | int] * 60)

    # --------- Fora do prazo de resolução ---------
    - name: Classificar incidentes fora do prazo de resolução
      set_fact:
        fora_resolucao: "{{ fora_resolucao + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d "' ~ (item.opened_at | default('1970-01-01 00:00:00')) ~ '" +%s') | int)
          }}
        delta_open_sec: "{{ (now_epoch | int) - (opened_epoch | int) }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - (delta_open_sec | int) >= (resolucao_minutos.get(item.priority | int, resolucao_minutos['default']) * 60)

    # --------- Próximos de violar SLA ---------
    - name: Classificar incidentes próximos de violar SLA
      set_fact:
        near_breach: "{{ near_breach + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d "' ~ (item.opened_at | default('1970-01-01 00:00:00')) ~ '" +%s') | int)
          }}
        deadline_epoch: >-
          {{
            (opened_epoch | int)
            + (resolucao_minutos.get(item.priority | int, resolucao_minutos['default']) * 60)
          }}
        time_left_sec: "{{ (deadline_epoch | int) - (now_epoch | int) }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - (time_left_sec | int) > 0
        - (time_left_sec | int) <= (near_breach_minutes | int) * 60

    # ------------------ Saídas / Resumo ------------------
    - name: Contagens por bucket
      debug:
        msg:
          - "Novos (≤{{ window_minutes_new }}min): {{ novos | length }}"
          - "Fora do prazo de nomeação: {{ fora_nomeacao | length }}"
          - "Fora do prazo de resolução: {{ fora_resolucao | length }}"
          - "Próximos de violar SLA (≤{{ near_breach_minutes }}min): {{ near_breach | length }}"

    - name: Listas simples por bucket
      debug:
        msg:
          novos: "{{ novos | map(attribute='number') | list }}"
          fora_nomeacao: "{{ fora_nomeacao | map(attribute='number') | list }}"
          fora_resolucao: "{{ fora_resolucao | map(attribute='number') | list }}"
          near_breach: "{{ near_breach | map(attribute='number') | list }}"

    # --------- Notificação Google Chat ---------
    - name: Montar detalhes por incidente (com quebras de linha reais)
      set_fact:
        incident_details: >-
          {{
            incident_details | default([]) +
            [(
              "*Ticket:* " ~ (item.number | default("N/A")) ~ "\n"
              ~ "*Título:* " ~ (item.short_description | default("N/A")) ~ "\n"
              ~ "*Descrição:* " ~ (item.description | default("N/A")) ~ "\n"
              ~ "*Responsável:* " ~ (item.assigned_to | default("None")) ~ "\n"
              ~ "*Prioridade:* " ~ (item.priority | default("N/A") | string) ~ "\n"
              ~ "*Estado:* " ~ (item.state | default("N/A") | string) ~ "\n"
              ~ "*Categoria:* " ~ (item.category | default("N/A")) ~ "\n"
              ~ "*Aberto em:* " ~ (item.opened_at | default("N/A")) ~ "\n"
              ~ "*Última atualização:* " ~ (item.sys_updated_on | default("N/A")) ~ "\n"
              ~ "*Assignment group:* " ~ (item.assignment_group | default("")) ~ "\n"
              ~ "*Aprovação:* " ~ (item.approval | default("N/A")) ~ "\n"
              ~ "*Made SLA:* " ~ (item.made_sla | default("N/A") | string) ~ "\n"
              ~ "*Sys ID:* " ~ (item.sys_id | default("N/A"))
            )]
          }}
      loop: "{{ inc_all }}"

    - name: Montar mensagem final com resumo + detalhes
      set_fact:
        chat_text: |
          *Resumo SLA Incidentes*
          - Novos (≤{{ window_minutes_new }}min): {{ novos | length }}
          - Fora do prazo de nomeação: {{ fora_nomeacao | length }}
          - Fora do prazo de resolução: {{ fora_resolucao | length }}
          - Próximos de violar SLA (≤{{ near_breach_minutes }}min): {{ near_breach | length }}

          *Tickets novos:* {{ novos | map(attribute='number') | list }}
          *Tickets fora nomeação:* {{ fora_nomeacao | map(attribute='number') | list }}
          *Tickets fora resolução:* {{ fora_resolucao | map(attribute='number') | list }}
          *Tickets próximos SLA:* {{ near_breach | map(attribute='number') | list }}

          *Detalhes dos incidentes:*
          {{ incident_details | join('\n\n---\n\n') }}

    - name: Pré-visualizar mensagem
      debug:
        var: chat_text

    - name: Enviar mensagem para Google Chat
      uri:
        url: "{{ google_chat_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json; charset=UTF-8"
        body_format: json
        body:
          text: "{{ chat_text }}"
        status_code: 200
      when: google_chat_webhook_url is defined

