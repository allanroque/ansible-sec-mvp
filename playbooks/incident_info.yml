---
- name: Incidentes abertos + classificação SLA + notificação
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - servicenow.itsm

  vars:
    # Regras SLA em minutos
    near_breach_minutes: 60
    nomeacao_minutos:
      1: 15      # P1 - CRITICAL
      2: 30      # P2 - HIGH
      3: 90      # P3 - MEDIUM
      4: 180     # P4 - LOW
      5: 9999
    resolucao_minutos:
      1: 240     # P1 - 4h
      2: 900     # P2 - 15h
      3: 3600    # P3 - 2,5 dias
      4: 7200    # P4 - 5 dias
      default: 999999

  pre_tasks:
    - name: Resolver credenciais (vars → env)
      set_fact:
        sn_instance: "{{ (snow_instance is defined and snow_instance|length > 0)
                         | ternary(snow_instance, (ansible_env.SN_HOST | default(''))) }}"
        sn_username: "{{ (snow_username is defined and snow_username|length > 0)
                         | ternary(snow_username, (ansible_env.SN_USERNAME | default(''))) }}"
        sn_password: "{{ (snow_password is defined and snow_password|length > 0)
                         | ternary(snow_password, (ansible_env.SN_PASSWORD | default(''))) }}"

    - name: Validar credenciais
      assert:
        that:
          - sn_instance | length > 0
          - sn_username | length > 0
          - sn_password | length > 0
        fail_msg: >
          Defina snow_instance/snow_username/snow_password via -e
          ou exporte SN_HOST/SN_USERNAME/SN_PASSWORD no ambiente.

    - name: Mostrar credenciais resolvidas (sem senha)
      debug:
        msg:
          - "ServiceNow instance: {{ sn_instance }}"
          - "ServiceNow username: {{ sn_username }}"

  tasks:
    # ---------- Coletar incidentes no ServiceNow ----------
    - name: Buscar incidentes abertos (active=true)
      servicenow.itsm.incident_info:
        instance:
          host: "{{ sn_instance }}"
          username: "{{ sn_username }}"
          password: "{{ sn_password }}"
        sysparm_query: "active=true"
        sysparm_display_value: "true"
      register: abertas

    - name: Normalizar lista de incidentes
      set_fact:
        inc_all: "{{ abertas.records | default([]) }}"

    - name: Epoch atual (UTC)
      set_fact:
        now_epoch: "{{ lookup('pipe','date -u +%s') | int }}"

    - name: Inicializar buckets
      set_fact:
        fora_nomeacao: []
        fora_resolucao: []
        near_breach: []

    # --------- Fora do prazo de nomeação ---------
    - name: Classificar incidentes fora do prazo de nomeação
      set_fact:
        fora_nomeacao: "{{ fora_nomeacao + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d ' ~ ( (item.opened_at | default('')) | quote ) ~ ' +%s') | int)
              if (item.opened_at is defined and (item.opened_at | string | length) > 0) else 0
          }}
        delta_open_sec: "{{ (now_epoch | int) - (opened_epoch | int) }}"
        tem_owner: >-
          {{ (item.assigned_to is defined) and ((item.assigned_to | string | trim) != '') }}
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - not tem_owner
        - (item.priority | int) in nomeacao_minutos.keys()
        - (delta_open_sec | int) >= (nomeacao_minutos[item.priority | int] * 60)

    # --------- Fora do prazo de resolução ---------
    - name: Classificar incidentes fora do prazo de resolução
      set_fact:
        fora_resolucao: "{{ fora_resolucao + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d ' ~ ( (item.opened_at | default('')) | quote ) ~ ' +%s') | int)
              if (item.opened_at is defined and (item.opened_at | string | length) > 0) else 0
          }}
        delta_open_sec: "{{ (now_epoch | int) - (opened_epoch | int) }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - (delta_open_sec | int) >= (resolucao_minutos.get(item.priority | int, resolucao_minutos['default']) * 60)

    # --------- Próximos de violar SLA ---------
    - name: Classificar incidentes próximos de violar SLA
      set_fact:
        near_breach: "{{ near_breach + [ item ] }}"
      vars:
        opened_epoch: >-
          {{
            (lookup('pipe', 'date -u -d ' ~ ( (item.opened_at | default('')) | quote ) ~ ' +%s') | int)
              if (item.opened_at is defined and (item.opened_at | string | length) > 0) else 0
          }}
        deadline_epoch: >-
          {{
            (opened_epoch | int)
            + (resolucao_minutos.get(item.priority | int, resolucao_minutos['default']) * 60)
          }}
        time_left_sec: "{{ (deadline_epoch | int) - (now_epoch | int) }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"
      when:
        - (opened_epoch | int) > 0
        - (time_left_sec | int) > 0
        - (time_left_sec | int) <= (near_breach_minutes | int) * 60

    # ------------------ Saídas / Resumo ------------------
    - name: Contagens por bucket
      debug:
        msg:
          - "Fora do prazo de nomeação: {{ fora_nomeacao | length }}"
          - "Fora do prazo de resolução: {{ fora_resolucao | length }}"
          - "Próximos de violar SLA (≤{{ near_breach_minutes }}min): {{ near_breach | length }}"

    - name: Listas simples por bucket
      debug:
        msg:
          fora_nomeacao: "{{ fora_nomeacao | map(attribute='number') | list }}"
          fora_resolucao: "{{ fora_resolucao | map(attribute='number') | list }}"
          near_breach: "{{ near_breach | map(attribute='number') | list }}"

    # --------- Notificação Google Chat ---------
    - name: Montar mensagem final
      set_fact:
        chat_text: |-
          *Resumo SLA Incidentes*
          - Fora do prazo de nomeação: {{ fora_nomeacao | length }}
          - Fora do prazo de resolução: {{ fora_resolucao | length }}
          - Próximos de violar SLA (≤{{ near_breach_minutes }}min): {{ near_breach | length }}

          *Tickets fora nomeação:* {{ fora_nomeacao | map(attribute='number') | list }}
          *Tickets fora resolução:* {{ fora_resolucao | map(attribute='number') | list }}
          *Tickets próximos SLA:* {{ near_breach | map(attribute='number') | list }}

    - name: Pré-visualizar mensagem
      debug:
        var: chat_text

    - name: Enviar mensagem para Google Chat
      uri:
        url: "{{ google_chat_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json; charset=UTF-8"
        body_format: json
        body:
          text: "{{ chat_text }}"
        status_code: 200
      when: google_chat_webhook_url is defined
