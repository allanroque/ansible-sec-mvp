---
- name: Incidentes abertos + detalhes
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - servicenow.itsm

  vars:
    # Credenciais/instância (ideal: usar credencial no AAP)
    snow_instance: "{{ snow_instance | default(lookup('env','SN_HOST')) }}"
    snow_username: "{{ snow_username | default(lookup('env','SN_USERNAME')) }}"
    snow_password: "{{ snow_password | default(lookup('env','SN_PASSWORD')) }}"

    # Limites e janelas
    window_minutes_new: 15   # janela para "novos"
    stale_hours: 24          # sem update >= Xh
    near_breach_minutes: 60  # SLA vence em <= X min

  pre_tasks:
    - name: Resolver credenciais (vars → env) em nomes estáveis
      set_fact:
        sn_instance: "{{ (snow_instance is defined and snow_instance|length > 0)
                         | ternary(snow_instance, (ansible_env.SN_HOST | default(''))) }}"
        sn_username: "{{ (snow_username is defined and snow_username|length > 0)
                         | ternary(snow_username, (ansible_env.SN_USERNAME | default(''))) }}"
        sn_password: "{{ (snow_password is defined and snow_password|length > 0)
                         | ternary(snow_password, (ansible_env.SN_PASSWORD | default(''))) }}"

    - name: Validar credenciais
      assert:
        that:
          - sn_instance | length > 0
          - sn_username | length > 0
          - sn_password | length > 0
        fail_msg: >
          Defina snow_instance/snow_username/snow_password via -e
          ou exporte SN_HOST/SN_USERNAME/SN_PASSWORD no ambiente.


  tasks:
    # 1) Coleta única: todos incidentes ativos
    - name: Buscar incidentes abertos (active=true)
      servicenow.itsm.incident_info:
        instance:
          host: "{{ snow_instance }}"
          username: "{{ snow_username }}"
          password: "{{ snow_password }}"
        sysparm_query: "active=true"
        sysparm_display_value: "true"
      register: abertas

    - name: Debug da variável abertas
      debug:
        msg: "{{ abertas.records | map(attribute='number') | list }}"

    # 2) Guardar lista e sys_ids
    - name: Guardar lista de incidentes e sys_ids
      set_fact:
        inc_all: "{{ abertas.records | default([]) }}"
        inc_sys_ids: "{{ (abertas.records | map(attribute='sys_id') | list) | default([]) }}"

    # 3.1) Quantidade total
    - name: Contagem total
      debug:
        msg: "Total de incidentes abertos encontrados: {{ inc_all | length }}"

    # 3.2) Epoch atual
    - name: Epoch atual (UTC)
      set_fact:
        now_epoch: "{{ lookup('pipe', 'date -u +%s') | int }}"

    # 4) Inicializar buckets
    - name: Inicializar buckets
      set_fact:
        inc_new: []
        inc_stale: []

    # 5) Classificar NOVOS (opened_at <= janela)
    - name: Adicionar em NOVOS quando opened_at <= {{ window_minutes_new }} min atrás
      set_fact:
        inc_new: "{{ inc_new + [ item ] }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number }}"
      when:
        - item.opened_at is defined
        - item.opened_at | string | length > 0
        - >
          (
            now_epoch
            -
            (lookup('pipe', 'date -u -d \"' ~ item.opened_at ~ '\" +%s') | int)
          ) <= (window_minutes_new * 60)

    # 6) Classificar STALE (sem atualização há >= stale_hours)
    - name: Adicionar em STALE quando sem atualização há >= {{ stale_hours }}h
      set_fact:
        inc_stale: "{{ inc_stale + [ item ] }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number }}"
      when:
        - item.sys_updated_on is defined
        - item.sys_updated_on | string | length > 0
        - >
          (
            now_epoch
            -
            (lookup('pipe', 'date -u -d \"' ~ item.sys_updated_on ~ '\" +%s') | int)
          ) >= (stale_hours * 3600)

    # 7) Resumo dos buckets
    - name: Contagens por bucket
      debug:
        msg:
          - "Novos ({{ window_minutes_new }} min): {{ inc_new | length }}"
          - "Stale (>= {{ stale_hours }}h): {{ inc_stale | length }}"

    - name: Listas simples (números)
      debug:
        msg:
          novos:  "{{ inc_new   | map(attribute='number') | list }}"
          stale:  "{{ inc_stale | map(attribute='number') | list }}"

    # 8) Montar mensagem para Chat (opcional)
    - name: Montar mensagem (texto)
      set_fact:
        chat_text: |-
          *Incidentes novos ({{ inc_new | length }})*
          {{ (inc_new | map(attribute='number') | list) | default([]) }}

          *>= {{ stale_hours }}h sem atualização ({{ inc_stale | length }})*
          {{ (inc_stale | map(attribute='number') | list) | default([]) }}

    - name: Pré-visualizar mensagem
      debug:
        var: chat_text
