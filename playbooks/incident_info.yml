---
- name: Incidentes (ServiceNow) -> enviar tudo para Google Chat (sem filtros)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - servicenow.itsm

  vars:
    # ======== Google Chat (defina via -e ou var de group/host) ========
    # Ex.: -e google_chat_webhook_url="https://chat.googleapis.com/v1/spaces/..."
    google_chat_webhook_url: "{{ google_chat_webhook_url | default(omit) }}"

    # ======== Mapa de estados (opcional, só para impressão mais amigável) ========
    state_map:
      "1": New
      "2": In Progress
      "3": On Hold
      "6": Resolved
      "7": Closed
      "8": Canceled

  pre_tasks:
    # Credenciais podem vir por -e (snow_instance, snow_username, snow_password)
    # ou pelas variáveis de ambiente: SN_HOST / SN_USERNAME / SN_PASSWORD
    - name: Resolver credenciais (vars → env)
      set_fact:
        sn_instance: "{{ (snow_instance is defined and snow_instance|length > 0)
                         | ternary(snow_instance, (ansible_env.SN_HOST | default(''))) }}"
        sn_username: "{{ (snow_username is defined and snow_username|length > 0)
                         | ternary(snow_username, (ansible_env.SN_USERNAME | default(''))) }}"
        sn_password: "{{ (snow_password is defined and snow_password|length > 0)
                         | ternary(snow_password, (ansible_env.SN_PASSWORD | default(''))) }}"

    - name: Validar credenciais
      assert:
        that:
          - sn_instance | length > 0
          - sn_username | length > 0
          - sn_password | length > 0
        fail_msg: >
          Defina snow_instance/snow_username/snow_password via -e
          ou exporte SN_HOST/SN_USERNAME/SN_PASSWORD no ambiente.

  tasks:
    # ================== COLETA (ServiceNow) ==================
    - name: Buscar incidentes ativos do grupo TD-CYBEROPS-CSIRT-BR (sem filtros adicionais)
      servicenow.itsm.incident_info:
        instance:
          host: "{{ sn_instance }}"
          username: "{{ sn_username }}"
          password: "{{ sn_password }}"
        sysparm_query: "active=true^assignment_group.name=TD-CYBEROPS-CSIRT-BR"
        sysparm_display_value: "true"   # retorna nomes legíveis para campos de referência
      register: abertas

    - name: Normalizar lista de incidentes (tudo que veio ativo)
      set_fact:
        inc_all: "{{ abertas.records | default([]) }}"

    - name: Log de contagem
      debug:
        msg: "Incidentes ativos encontrados: {{ inc_all | length }}"

    # ================== MENSAGEM - RESUMO OPCIONAL ==================
    - name: Montar mensagem de RESUMO simples
      set_fact:
        chat_summary_text: |
          *Incidentes ativos (TD-CYBEROPS-CSIRT-BR | ServiceNow)*
          Total: {{ inc_all | length }}
          Tickets: {{ inc_all | map(attribute='number') | list | default([]) }}

    - name: Enviar RESUMO ao Google Chat
      when:
        - google_chat_webhook_url is defined
      uri:
        url: "{{ google_chat_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json; charset=UTF-8"
        body_format: json
        body:
          text: "{{ chat_summary_text }}"
        status_code: 200

    # ================== MENSAGEM - 1 CARD POR INCIDENTE ==================
    - name: Zerar acumulador de mensagens por incidente
      set_fact:
        incident_cards: []

    - name: Montar card (texto) por incidente
      set_fact:
        incident_cards: >-
          {{
            incident_cards + [
              (
                [
                  "*Ticket:* " ~ (item.number | default("N/A")),
                  "*Título:* " ~ (item.short_description | default("N/A")),
                  "*Descrição:* " ~ descr_final,
                  "*Responsável:* " ~ owner_print,
                  "*Prioridade:* " ~ ((item.priority | default("N/A")) | string),
                  "*Estado:* " ~ state_label,
                  "*Categoria:* " ~ (item.category | default("N/A") | string),
                  "*Aberto em:* " ~ (item.opened_at | default("N/A")),
                  "*Última atualização:* " ~ (item.sys_updated_on | default("N/A")),
                  "*Assignment group:* " ~ (item.assignment_group | default("") | string),
                  "*Aprovação:* " ~ (item.approval | default("N/A") | string),
                  "*Made SLA:* " ~ (item.made_sla | default("N/A") | string),
                  "*Sys ID:* " ~ (item.sys_id | default("N/A") | string)
                ]
                | reject('equalto', omit)
                | join("\n")
              )
            ]
          }}
      vars:
        state_code: "{{ (item.state | default(item.incident_state | default('')) | string) }}"
        state_label: "{{ state_map.get(state_code, state_code) }}"
        descr_raw: >-
          {{
              (item.description | default('') | string | trim)
           or (item.u_problem_description | default('') | string | trim)
           or (item.comments | default('') | string | trim)
           or (item.work_notes | default('') | string | trim)
           or (item.short_description | default('') | string | trim)
          }}
        descr_normalized: "{{ descr_raw | regex_replace('\\\\n', '\n') }}"
        descr_final: "{{ descr_normalized | truncate(2000, True, '…') }}"
        owner: "{{ (item.assigned_to | default('') | string | trim) }}"
        owner_print: "{{ owner if owner else '(não atribuído)' }}"
      loop: "{{ inc_all }}"
      loop_control:
        label: "{{ item.number | default('sem-number') }}"

    - name: Sanitizar cards (trocar '\n' literal por newline real)
      set_fact:
        incident_cards_clean: "{{ incident_cards | map('regex_replace', '\\\\n', '\n') | list }}"

    - name: Enviar UMA MENSAGEM por incidente ao Google Chat
      when:
        - google_chat_webhook_url is defined
        - (incident_cards_clean | length) > 0
      uri:
        url: "{{ google_chat_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json; charset=UTF-8"
        body_format: json
        body: "{{ {'text': item} | to_json }}"
        status_code: 200
      loop: "{{ incident_cards_clean }}"
      loop_control:
        label: "{{ item.split('\n')[0] }}"

