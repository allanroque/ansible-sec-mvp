---
- name: Get New Incidents from ServiceNow
  hosts: localhost
  connection: local
  vars:
    # Configura√ß√µes de filtro para tickets novos
    new_ticket_threshold_hours: 24  # Buscar tickets das √∫ltimas 24h
    max_results: 50  # Limitar n√∫mero de resultados para performance
  
  tasks:
    - name: Calculate timestamp for new tickets
      set_fact:
        new_ticket_timestamp: "{{ (ansible_date_time.epoch | int) - (new_ticket_threshold_hours * 3600) }}"
    
    - name: Convert timestamp to ServiceNow format
      set_fact:
        snow_timestamp: "{{ new_ticket_timestamp | int | strftime('%Y-%m-%d %H:%M:%S') }}"
    
    - name: Get new incidents only via REST API
      uri:
        url: "https://{{ snow_instance }}/api/now/table/incident"
        method: GET
        user: "{{ snow_username }}"
        password: "{{ snow_password }}"
        force_basic_auth: yes
        headers:
          Accept: "application/json"
        url_username: "{{ snow_username }}"
        url_password: "{{ snow_password }}"
        validate_certs: yes
        return_content: yes
        # Query otimizada para buscar apenas incidentes novos
        url_extra_params:
          sysparm_query: "opened_at>={{ snow_timestamp }}^state=1^priorityIN1,2,3"
          sysparm_limit: "{{ max_results }}"
          sysparm_display_value: "true"
          sysparm_exclude_reference_link: "true"
          sysparm_fields: "number,short_description,priority,opened_at,caller_id,sys_id,state,category,impact,urgency"
      register: new_incidents
      retries: 3
      delay: 5
      until: new_incidents.status == 200
    
    - name: Filter only active new incidents
      set_fact:
        filtered_new_incidents: "{{ new_incidents.json.result | selectattr('state', 'equalto', '1') | list }}"
    
    - name: Display summary of new incidents
      debug:
        msg: |
          üìä **Resumo de Incidentes Novos**
          
          ‚Ä¢ Total encontrados: {{ new_incidents.json.result | length }}
          ‚Ä¢ Novos ativos: {{ filtered_new_incidents | length }}
          ‚Ä¢ Per√≠odo: √∫ltimas {{ new_ticket_threshold_hours }} horas
          ‚Ä¢ Timestamp de busca: {{ snow_timestamp }}
          ‚Ä¢ Tempo de resposta: {{ new_incidents.elapsed }}ms
    
    - name: Display new incidents details
      debug:
        msg: |
          üö® **Incidente**: {{ item.number }}
          üìù **Descri√ß√£o**: {{ item.short_description }}
          üè∑Ô∏è **Prioridade**: {{ item.priority }}
          üìÖ **Aberto em**: {{ item.opened_at }}
          üë§ **Solicitante**: {{ item.caller_id }}
          üè∑Ô∏è **Categoria**: {{ item.category }}
          ‚ö° **Impacto**: {{ item.impact }}
          üö® **Urg√™ncia**: {{ item.urgency }}
          üîó **Link**: https://{{ snow_instance }}/nav_to.do?uri=incident.do?sys_id={{ item.sys_id }}
      loop: "{{ filtered_new_incidents }}"
      when: filtered_new_incidents | length > 0
    
    - name: No new incidents found
      debug:
        msg: "‚úÖ Nenhum incidente novo encontrado nas √∫ltimas {{ new_ticket_threshold_hours }} horas"
      when: filtered_new_incidents | length == 0
    
    - name: Performance metrics
      debug:
        msg: |
          ‚ö° **M√©tricas de Performance**
          
          ‚Ä¢ Tempo total de execu√ß√£o: {{ new_incidents.elapsed }}ms
          ‚Ä¢ Registros retornados: {{ new_incidents.json.result | length }}
          ‚Ä¢ Tamanho da resposta: {{ new_incidents.json | length }} bytes
          ‚Ä¢ Status da requisi√ß√£o: {{ new_incidents.status }}
